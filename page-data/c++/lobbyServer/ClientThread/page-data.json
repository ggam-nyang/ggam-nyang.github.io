{"componentChunkName":"component---src-templates-blog-template-js","path":"/c++/lobbyServer/ClientThread/","result":{"data":{"cur":{"id":"e92e68b6-131b-5243-bde1-4ad8cb1e879e","html":"<h3 id=\"클라이언트-스레드-관리\" style=\"position:relative;\"><a href=\"#%ED%81%B4%EB%9D%BC%EC%9D%B4%EC%96%B8%ED%8A%B8-%EC%8A%A4%EB%A0%88%EB%93%9C-%EA%B4%80%EB%A6%AC\" aria-label=\"클라이언트 스레드 관리 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>클라이언트 스레드 관리</h3>\n<blockquote>\n<p>요약</p>\n</blockquote>\n<p>클라이언트에서 전투 시작 시 콘솔 입력 + 패킷 처리가 동시에 실행이 되지 않았던 이유는\n<strong>콘솔 입력 작업을 중복으로 큐에 추가</strong>하여, 모든 스레드가 블로킹 됐기 때문이다.</p>\n<blockquote>\n</blockquote>\n<h2 id=\"문제-상황\" style=\"position:relative;\"><a href=\"#%EB%AC%B8%EC%A0%9C-%EC%83%81%ED%99%A9\" aria-label=\"문제 상황 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>문제 상황</h2>\n<p>boost asio를 이용해 소켓 프로그래밍을 구축했습니다.\n클라이언트의 스레드 구조는 아래와 같습니다.</p>\n<div class=\"gatsby-highlight\" data-language=\"cpp\"><pre class=\"language-cpp\"><code class=\"language-cpp\"><span class=\"token keyword\">void</span> <span class=\"token class-name\">Client</span><span class=\"token double-colon punctuation\">::</span><span class=\"token function\">Start</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">int</span> i <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span> i <span class=\"token operator\">&lt;</span> <span class=\"token number\">4</span><span class=\"token punctuation\">;</span> i<span class=\"token operator\">++</span><span class=\"token punctuation\">)</span>\n    thread_group_<span class=\"token punctuation\">.</span><span class=\"token function\">create_thread</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span> <span class=\"token function\">WorkerThread</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n  <span class=\"token comment\">// thread 잘 만들어질때까지 잠시 기다리는 부분</span>\n  this_thread<span class=\"token double-colon punctuation\">::</span><span class=\"token function\">sleep_for</span><span class=\"token punctuation\">(</span>chrono<span class=\"token double-colon punctuation\">::</span><span class=\"token function\">milliseconds</span><span class=\"token punctuation\">(</span><span class=\"token number\">100</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n  io_context_<span class=\"token punctuation\">.</span><span class=\"token function\">post</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span> <span class=\"token function\">TryConnect</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n  thread_group_<span class=\"token punctuation\">.</span><span class=\"token function\">join_all</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">void</span> <span class=\"token class-name\">Client</span><span class=\"token double-colon punctuation\">::</span><span class=\"token function\">WorkerThread</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>\n  io_context_<span class=\"token punctuation\">.</span><span class=\"token function\">run</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>4개의 작업스레드를 생성하고, io_context에 post된 작업을 스레드가 가져가서 작업을 하는 형태입니다.</p>\n<p>post 되는 작업은<br>\nSend() : 콘솔 입력 + 패킷 전송<br>\nReceive() : 패킷 수신 + 콘솔 출력</p>\n<p>2개의 작업뿐입니다.</p>\n<h3 id=\"이해도-부족\" style=\"position:relative;\"><a href=\"#%EC%9D%B4%ED%95%B4%EB%8F%84-%EB%B6%80%EC%A1%B1\" aria-label=\"이해도 부족 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>이해도 부족</h3>\n<p><a href=\"https://www.notion.so/non-blocking-482db3eff26f4a23bb9a83676337997e?pvs=21\">처음 문제에 대해 다뤘던 문서</a> (읽어보지 않아도 됩니다..!)<br>\n요약 :<br>\n콘솔 입력 작업 / 패킷 수신 작업 2개의 작업이 존재하는데, <strong>패킷 수신 작업이 1초마다 반복될 때</strong>, 두 작업이 동시에 진행되지 않았습니다.</p>\n<p>정리했던 문서의 결과는 다음과 같습니다.\ngetline() 함수는 블로킹 함수이고, 이로 인해 다른 스레드에서 동작해야할 패킷 수신 작업이 진행되지 않았다.\n→ <strong>조건 변수</strong>를 통해 10초동안 네트워크 작업이 발생하는 전투 중엔 getLine() 함수가 실행되지 않도록 했습니다.</p>\n<p>결론적으로 1번의 디버깅은 <strong>완전한 실패</strong>입니다.</p>\n<ul>\n<li><strong>블로킹 함수에 대한 이해 부족</strong>\n<ul>\n<li>\n<p>블로킹 함수는 함수의 동작이 완료될 때까지 스레드가 blocking 되는 함수입니다.\n함수가 return 되기 전에는 해당 스레드는 다른 작업을 수행할 수 없습니다.</p>\n</li>\n<li>\n<p>멀티스레드 프로그래밍의 목적은 CPU 사용량을 높이는 것 입니다. 즉, 블로킹 함수가 실행된다고 해도 다른 스레드가 cpu를 점유해서 일을 할 수 있습니다. 때문에 블로킹과 멀티스레드는 상호보완적인 관계(?)라고 볼 수 있습니다.</p>\n</li>\n<li>\n<p>조건 변수를 통해 문제를 해결하긴 했지만, 블로킹 함수로 인해 다른 스레드가 차단되는 것은 아닙니다.</p>\n</li>\n</ul>\n</li>\n<li><strong>작업 큐를 통해 실행되는 Boost asio에 대한 이해 부족</strong>\n<ul>\n<li>Boost asio를 사용해 소켓 서버를 구현할 때, io_context를 사용합니다.</li>\n<li>io_context는 async I/O를 도와주고, 이벤트 큐 방식으로 비동기 작업을 처리하도록 해줍니다.</li>\n</ul>\n</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"c++\"><pre class=\"language-c++\"><code class=\"language-c++\">void Client::Send() {\n  getline(std::cin, writeBuffer_);\n  packetManager_.SendPacket(this, writeBuffer_);\n}\n\nvoid Client::SendHandle(const system::error_code&amp; ec, const char* packet) {\n    ...\n  // 재귀적으로 Send()가 post됨\n  io_context_.post([this]() { Send(); });\n}\n\n// 배틀을 시작하게 될 경우\nvoid Client::Battle() {\n    ...\n    \n    // 마지막에 재귀적으로 Send()를 post하게 됨\n    packetManager_.SendAttackPacket(this, 1);\n    \n    timer_.expires_from_now(std::chrono::seconds(1));\n    timer_.async_wait(\n      [this](const boost::system::error_code&amp; ec) { Battle(ec); });\n}</code></pre></div>\n<p>Send, Receive 두 함수는 모두 마지막에 같은 작업을 큐에 post 합니다. 재귀함수와 비슷합니다.</p>\n<p>그런데 전투 중에 1초마다 패킷을 보낼 때도, Send가 post 됐습니다.<br>\n결국, 작업 큐에 Send 10개 Receive 1개가 존재하고 스레드가 4개인 환경에서 모든 스레드가 Send를 실행하며 블로킹되어 Receive를 실행하지 못합니다.</p>\n<h2 id=\"해결\" style=\"position:relative;\"><a href=\"#%ED%95%B4%EA%B2%B0\" aria-label=\"해결 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>해결</h2>\n<ul>\n<li>\n<p><strong>(현재 임시방편..!)</strong> 단순하게는 <code class=\"language-text\">ATTACK_REQUEST</code> 의 경우 콘솔 입력과 분리하고 Send 함수를 작업 큐에 추가하지 않습니다.</p>\n<ul>\n<li>전투 시작 시, <code class=\"language-text\">ATTACK_REQUEST_PACKET</code> 을 1초마다 전송합니다.</li>\n<li>이때 Send 함수를 이벤트 큐에 post 하지 않습니다.</li>\n</ul>\n</li>\n<li>\n<p><strong>현재 구조가 이상한 것이지만, 1번의 경우 일관성이 깨집니다.</strong></p>\n<ul>\n<li>클라이언트의 UI, 네트워크가 결합되어 있습니다.</li>\n<li>이를 분리하여 코드 가독성과 유지보수성을 개선하고 위와 같은 오류 발생을 막습니다.</li>\n</ul>\n</li>\n</ul>\n<p>때문에 콘솔 입출력 로직과 패킷 송수신 로직의 분리가 필요합니다.</p>","excerpt":"클라이언트 스레드 관리 요약 클라이언트에서 전투 시작 시 콘솔 입력 + 패킷 처리가 동시에 실행이 되지 않았던 이유는\n콘솔 입력 작업을 중복으로 큐에 추가하여, 모든 스레드가 블로킹 됐기 때문이다. 문제 상황 boost asio를 이용해 소켓 프로그래밍을 구축했습니다.\n클라이언트의 스레드 구조는 아래와 같습니다. 4개의 작업스레드를 생성하고, io_context에 post된 작업을 스레드가 가져가서 작업을 하는 형태입니다. post 되는 작업은 Send() : 콘솔 입력 + 패킷 전송 Receive() : 패킷 수신 + 콘솔 출력 2개의 작업뿐입니다. 이해도 부족 처음 문제에 대해 다뤘던 문서 (읽어보지 않아도 됩니다..!) 요약 : 콘솔 입력 작업 / 패킷 수신 작업 2개의 작업이 존재하는데, 패킷 수신 작업이 1초마다 반복될 때, 두 작업이 동시에 진행되지 않았습니다. 정리했던 문서의 결과는 다음과 같습니다.\ngetline() 함수는 블로킹 함수이고, 이로 인해 다른 스레드에서…","frontmatter":{"date":"May 01, 2024","title":"클라이언트 콘솔 입력 스레드 분리하기","categories":"C++ Boost","author":"지구깜냥","emoji":"✏️"},"fields":{"slug":"/c++/lobbyServer/ClientThread/"}},"next":{"id":"06f7f157-f0b3-5d74-885e-dbc3db2a7015","html":"<h2 id=\"boost-asioio_servicework-란\" style=\"position:relative;\"><a href=\"#boost-asioio_servicework-%EB%9E%80\" aria-label=\"boost asioio_servicework 란 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Boost asio::io_service::work 란?</h2>\n<p>Boost asio를 사용해 소켓 서버를 생성하면, 항상 io_service(지금은 io_context로 대체)를 사용하게 된다.<br>\n<a href=\"https://stackoverflow.com/questions/17156541/why-do-we-need-to-use-boostasioio-servicework\">링크</a>에선 work를 사용해야 하는 이유를 다루고 있다.</p>\n<div class=\"gatsby-highlight\" data-language=\"cpp\"><pre class=\"language-cpp\"><code class=\"language-cpp\"><span class=\"token keyword\">int</span> <span class=\"token function\">main</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">{</span>\n    boost<span class=\"token double-colon punctuation\">::</span>asio<span class=\"token double-colon punctuation\">::</span>io_service srv<span class=\"token punctuation\">;</span>\n    boost<span class=\"token double-colon punctuation\">::</span>asio<span class=\"token double-colon punctuation\">::</span>io_service<span class=\"token double-colon punctuation\">::</span>work <span class=\"token function\">work</span><span class=\"token punctuation\">(</span>srv<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    boost<span class=\"token double-colon punctuation\">::</span>thread_group thr_grp<span class=\"token punctuation\">;</span>\n    thr_grp<span class=\"token punctuation\">.</span><span class=\"token function\">create_thread</span><span class=\"token punctuation\">(</span>boost<span class=\"token double-colon punctuation\">::</span><span class=\"token function\">bind</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span>boost<span class=\"token double-colon punctuation\">::</span>asio<span class=\"token double-colon punctuation\">::</span>io_service<span class=\"token double-colon punctuation\">::</span>run<span class=\"token punctuation\">,</span> <span class=\"token operator\">&amp;</span>srv<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    thr_grp<span class=\"token punctuation\">.</span><span class=\"token function\">create_thread</span><span class=\"token punctuation\">(</span>boost<span class=\"token double-colon punctuation\">::</span><span class=\"token function\">bind</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span>boost<span class=\"token double-colon punctuation\">::</span>asio<span class=\"token double-colon punctuation\">::</span>io_service<span class=\"token double-colon punctuation\">::</span>run<span class=\"token punctuation\">,</span> <span class=\"token operator\">&amp;</span>srv<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    srv<span class=\"token punctuation\">.</span><span class=\"token function\">post</span><span class=\"token punctuation\">(</span>boost<span class=\"token double-colon punctuation\">::</span><span class=\"token function\">bind</span><span class=\"token punctuation\">(</span>f1<span class=\"token punctuation\">,</span> <span class=\"token number\">123</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    srv<span class=\"token punctuation\">.</span><span class=\"token function\">post</span><span class=\"token punctuation\">(</span>boost<span class=\"token double-colon punctuation\">::</span><span class=\"token function\">bind</span><span class=\"token punctuation\">(</span>f1<span class=\"token punctuation\">,</span> <span class=\"token number\">321</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token comment\">//sync</span>\n\n    srv<span class=\"token punctuation\">.</span><span class=\"token function\">post</span><span class=\"token punctuation\">(</span>boost<span class=\"token double-colon punctuation\">::</span><span class=\"token function\">bind</span><span class=\"token punctuation\">(</span>f2<span class=\"token punctuation\">,</span> <span class=\"token number\">456</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    srv<span class=\"token punctuation\">.</span><span class=\"token function\">post</span><span class=\"token punctuation\">(</span>boost<span class=\"token double-colon punctuation\">::</span><span class=\"token function\">bind</span><span class=\"token punctuation\">(</span>f2<span class=\"token punctuation\">,</span> <span class=\"token number\">654</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token comment\">//sync</span>\n\n    srv<span class=\"token punctuation\">.</span><span class=\"token function\">stop</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    thr_grp<span class=\"token punctuation\">.</span><span class=\"token function\">join</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<div class=\"gatsby-highlight\" data-language=\"cpp\"><pre class=\"language-cpp\"><code class=\"language-cpp\"><span class=\"token keyword\">int</span> <span class=\"token function\">main</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">{</span>\n    boost<span class=\"token double-colon punctuation\">::</span>asio<span class=\"token double-colon punctuation\">::</span>io_service srv<span class=\"token punctuation\">;</span>\n    <span class=\"token comment\">//boost::asio::io_service::work work(srv);</span>\n    std<span class=\"token double-colon punctuation\">::</span>vector<span class=\"token operator\">&lt;</span>boost<span class=\"token double-colon punctuation\">::</span>thread<span class=\"token operator\">></span> thr_grp<span class=\"token punctuation\">;</span>\n\n    srv<span class=\"token punctuation\">.</span><span class=\"token function\">post</span><span class=\"token punctuation\">(</span>boost<span class=\"token double-colon punctuation\">::</span><span class=\"token function\">bind</span><span class=\"token punctuation\">(</span>f1<span class=\"token punctuation\">,</span> <span class=\"token number\">123</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    srv<span class=\"token punctuation\">.</span><span class=\"token function\">post</span><span class=\"token punctuation\">(</span>boost<span class=\"token double-colon punctuation\">::</span><span class=\"token function\">bind</span><span class=\"token punctuation\">(</span>f1<span class=\"token punctuation\">,</span> <span class=\"token number\">321</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token comment\">//sync</span>\n\n    srv<span class=\"token punctuation\">.</span><span class=\"token function\">post</span><span class=\"token punctuation\">(</span>boost<span class=\"token double-colon punctuation\">::</span><span class=\"token function\">bind</span><span class=\"token punctuation\">(</span>f2<span class=\"token punctuation\">,</span> <span class=\"token number\">456</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    srv<span class=\"token punctuation\">.</span><span class=\"token function\">post</span><span class=\"token punctuation\">(</span>boost<span class=\"token double-colon punctuation\">::</span><span class=\"token function\">bind</span><span class=\"token punctuation\">(</span>f2<span class=\"token punctuation\">,</span> <span class=\"token number\">654</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token comment\">//sync</span>\n\n    <span class=\"token comment\">// What is the difference between the poll and run, when io_service without work?</span>\n    thr_grp<span class=\"token punctuation\">.</span><span class=\"token function\">emplace_back</span><span class=\"token punctuation\">(</span>boost<span class=\"token double-colon punctuation\">::</span><span class=\"token function\">bind</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span>boost<span class=\"token double-colon punctuation\">::</span>asio<span class=\"token double-colon punctuation\">::</span>io_service<span class=\"token double-colon punctuation\">::</span>poll<span class=\"token punctuation\">,</span> <span class=\"token operator\">&amp;</span>srv<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><span class=\"token comment\">// poll or run?</span>\n    thr_grp<span class=\"token punctuation\">.</span><span class=\"token function\">emplace_back</span><span class=\"token punctuation\">(</span>boost<span class=\"token double-colon punctuation\">::</span><span class=\"token function\">bind</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span>boost<span class=\"token double-colon punctuation\">::</span>asio<span class=\"token double-colon punctuation\">::</span>io_service<span class=\"token double-colon punctuation\">::</span>run<span class=\"token punctuation\">,</span> <span class=\"token operator\">&amp;</span>srv<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><span class=\"token comment\">// poll or run? </span>\n\n    srv<span class=\"token punctuation\">.</span><span class=\"token function\">stop</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">for</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">auto</span> <span class=\"token operator\">&amp;</span>i <span class=\"token operator\">:</span> thr_grp<span class=\"token punctuation\">)</span> i<span class=\"token punctuation\">.</span><span class=\"token function\">join</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">int</span> b<span class=\"token punctuation\">;</span>\n    std<span class=\"token double-colon punctuation\">::</span>cin <span class=\"token operator\">>></span> b<span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">return</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>두 코드를 보면, 1. thread 생성, 2. 작업 post,  두 개의 작업이 존재하고\n1번 코드는 1 → 2 (work 객체와 함께)\n2번 코드는 2 → 1 의 순서로 코드 흐름이 이어진다.</p>\n<p>post는 IO Execution Context(여기선 io_service)에서 실행하겠다는 의미이다.\n모든 context는 run을 실행해줘야 하는데, 여기선 thread를 생성하고 <code class=\"language-text\">io_service::run</code> 작업을 실행한다.</p>\n<p>즉, 1번 코드는 IO Context run 이후 post\n2번 코드는 post 이후 IO Context를 run 한다.</p>\n<p><strong>즉, 남은 작업이 존재하지 않아도 io_service가 run을 반환하지 않도록 도와주는 것이 work의 역할이다.</strong></p>\n<p>ps. Deprecated 된 work 대신 <a href=\"https://chelseafandev.github.io/2022/01/11/prevent-io-context-run-from-returning/\">executor_work_guard</a> 를 사용한다.</p>","frontmatter":{"date":"March 23, 2024","title":"Boost Work란?","categories":"C++ Boost","author":"지구깜냥","emoji":"✏️"},"fields":{"slug":"/c++/lobbyServer/Boost-Work/"}},"prev":null,"site":{"siteMetadata":{"siteUrl":"https://ggam-nyang.github.io","comments":{"utterances":{"repo":"ggam-nyang/ggam-nyang.github.io"}}}}},"pageContext":{"slug":"/c++/lobbyServer/ClientThread/","nextSlug":"/c++/lobbyServer/Boost-Work/","prevSlug":""}},"staticQueryHashes":["1073350324","1956554647","2938748437"]}